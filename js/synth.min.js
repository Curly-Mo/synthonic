var audioContext,voices=[],output,instrument=new Instrument,presets={},noise_buffer;function frequencyFromNoteNumber(a){return 440*Math.pow(2,(a-69)/12)}function allZeros(a){for(i=0;i<a.length;i++)if(0!==a[i])return!1;return!0}function zeroArray(a){return Array.apply(null,Array(a)).map(Number.prototype.valueOf,0)}function filledArray(a,b){return Array.apply(null,Array(a)).map(Number.prototype.valueOf,b)}function copyObject(a){return JSON.parse(JSON.stringify(a))}
function linspace(a,b,c){"undefined"===typeof c&&(c=Math.max(Math.round(b-a)+1,1));if(2>c)return 1===c?[a]:[];var d,e=Array(c);c--;for(d=c;0<=d;d--)e[d]=(d*b+(c-d)*a)/c;return e}function logspace(a,b,c){0==a?(a=-3,b=Math.log(b)/Math.LN10):0==b?(b=-3,a=Math.log(a)/Math.LN10):(a=Math.log(a)/Math.LN10,b=Math.log(b)/Math.LN10);return linspace(a,b,c).map(function(a){return Math.pow(10,a)})}
function inverse(a){a=a.slice();for(var b=Math.max.apply(null,a),c=0;c<a.length;c++)a[c]=b-a[c];return a.reverse()}function greyNoise(a,b,c){b-=a;for(var d=linspace(1,0,3*c/5),d=d.concat(linspace(0,1,3*c/5)),d=d.slice(0,c),e=0;e<c;e++)d[e]=d[e]*d[e]*b+a;return d}function noiseBuffer(a){for(var b=audioContext.createBuffer(1,a,audioContext.sampleRate),c=b.getChannelData(0),d=0;d<a;d++)c[d]=2*Math.random()-1;return b}
function noteOn(a,b){if(null==voices[a]){console.log("note on: "+a+" "+b);voices[a]=new Voice(instrument,a,b);var c=document.getElementById("k"+a);c&&c.classList.add("pressed")}}function noteOff(a){null!=voices[a]&&(voices[a].noteOff(),voices[a]=null,(a=document.getElementById("k"+a))&&a.classList.remove("pressed"))}function Instrument(a,b){this.harmonics=a;this.noises=b||[new Envelope]}Instrument.prototype.Copy=function(){return new Instrument(this.harmonics,this.noises)};
function Envelope(a,b,c,d,e,g,h,f){this.attack_env=b||zeroArray(10);this.release_env=c||zeroArray(10);this.attack_time=d||.1;this.release_time=e||.1;this.harmonic=a||1;this.vibrato=g||{frequency:0,amplitude:0};this.tremolo=h||{frequency:0,amplitude:0};this.equalizer=f||zeroArray(30)}Envelope.prototype.Copy=function(){return new Envelope(this.harmonic,this.attack_env,this.release_env,this.attack_time,this.release_time,this.vibrato,this.tremolo)};
function Equalizer(a){this.filters=Array(a);var b=22500/(a+2),c=audioContext.createBiquadFilter();c.type="lowshelf";c.frequency.value=b;c.Q.value=15;this.filters[0]=c;c=audioContext.createBiquadFilter();c.type="highshelf";c.frequency.value=b*a;c.Q.value=15;this.filters[a-1]=c;for(var d=1;d<a-1;d++)c=audioContext.createBiquadFilter(),c.type="peaking",c.frequency.value=b*(d+1),c.Q.value=15,this.filters[d]=c,this.filters[d-1].connect(this.filters[d]);this.filters[a-2].connect(this.filters[a-1]);this.input=
this.filters[0];this.output=this.filters[a-1]}
function Voice(a,b,c){this.instrument=a;this.num_harmonics=a.harmonics.length;this.frequency=frequencyFromNoteNumber(b);this.postGain=audioContext.createGain();this.oscillators=[];this.gain_envs=[];this.noises=[];this.noise_gain_envs=[];this.max_volume=0;now=audioContext.currentTime;for(b=0;b<this.num_harmonics;b++){var d=a.harmonics[b];if(!allZeros(d.attack_env)||!allZeros(d.release_env)){var e=audioContext.createOscillator();e.frequency.value=this.frequency*d.harmonic;var g=audioContext.createGain();
g.gain.setValueAtTime(0,now);for(var h=d.attack_env,f=0;f<h.length;f++)time=d.attack_time*f/(h.length-1),g.gain.linearRampToValueAtTime(h[f],now+time);0!=d.vibrato.frequency&&0!=d.vibrato.amplitude&&(h=audioContext.createOscillator(),f=audioContext.createGain(),h.frequency.value=d.vibrato.frequency,f.gain.value=d.vibrato.amplitude,h.connect(f),f.connect(e.frequency),h.start(0));if(0!=d.tremolo.frequency&&0!=d.tremolo.amplitude){var h=audioContext.createOscillator(),f=audioContext.createGain(),k=audioContext.createGain();
h.frequency.value=d.tremolo.frequency;f.gain.value=d.tremolo.amplitude;k.gain.value=1;h.connect(f);f.connect(k.gain);h.start(0);e.connect(k);k.connect(g)}else e.connect(g);g.connect(this.postGain);this.oscillators[b]=e;this.gain_envs[b]=g;e.start(0)}}for(b=0;b<a.noises.length;b++)if(d=a.noises[b],!allZeros(d.attack_env)||!allZeros(d.release_env)){e=audioContext.createBufferSource();e.buffer=noiseBuffer(3*audioContext.sampleRate);e.loop=!0;g=audioContext.createGain();g.gain.setValueAtTime(0,now);h=
d.attack_env;for(f=0;f<h.length;f++)time=d.attack_time*f/(h.length-1),g.gain.linearRampToValueAtTime(h[f],now+time);0!=d.vibrato.frequency&&0!=d.vibrato.amplitude&&(h=audioContext.createOscillator(),f=audioContext.createGain(),h.frequency.value=d.vibrato.frequency,f.gain.value=d.vibrato.amplitude,h.connect(f),f.connect(e.detune),h.start(0));0!=d.tremolo.frequency&&0!=d.tremolo.amplitude?(h=audioContext.createOscillator(),f=audioContext.createGain(),k=audioContext.createGain(),h.frequency.value=d.tremolo.frequency,
f.gain.value=d.tremolo.amplitude,k.gain.value=1,h.connect(f),f.connect(k.gain),h.start(0),e.connect(k),k.connect(g)):e.connect(g);equalizer=new Equalizer(d.equalizer.length);for(f=0;f<equalizer.filters.length;f++)equalizer.filters[f].gain.value=d.equalizer[f];g.connect(equalizer.input);equalizer.output.connect(this.postGain);this.noises[b]=e;this.noise_gain_envs[b]=g;e.start(0)}this.postGain.connect(output);this.postGain.gain.value=5/this.num_harmonics*c}
Voice.prototype.noteOff=function(){var a=audioContext.currentTime;console.log("noteoff: now: "+a);for(var b=0;b<this.num_harmonics;b++){var c=this.oscillators[b];if(null!=c){var d=this.gain_envs[b];d.gain.cancelScheduledValues(a);var e=d.gain.value.toFixed(6)/this.instrument.harmonics[b].release_env[0].toFixed(6);isFinite(e)||(e=1);for(var g=this.instrument.harmonics[b].release_env,h=0;h<g.length;h++){var f=this.instrument.harmonics[b].release_time*h/(g.length-1);d.gain.linearRampToValueAtTime(g[h]*
e,a+f)}c.stop(a+2*parseFloat(f))}}for(b=0;b<this.instrument.noises.length;b++)if(c=this.noises[b],null!=c){d=this.noise_gain_envs[b];d.gain.cancelScheduledValues(a);e=d.gain.value.toFixed(6)/this.instrument.noises[b].release_env[0].toFixed(6);isFinite(e)||(e=1);g=this.instrument.noises[b].release_env;for(h=0;h<g.length;h++)f=this.instrument.noises[b].release_time*h/(g.length-1),d.gain.linearRampToValueAtTime(g[h]*e,a+f);c.stop(a+2*parseFloat(f))}};
function sinePreset(a){a=Array(a);var b=new Envelope(1,[0,.025,.05,.1,.2,.4,.8,1,1,1],[1,1,1,.8,.4,.2,.1,.05,.025,0],.1,.1);a[0]=b;for(var c=1;c<a.length;c++)b=new Envelope(c+1,zeroArray(10),zeroArray(10),.1,.1),a[c]=b;return new Instrument(a)}
function squarePreset(a){a=Array(a);for(var b=0;b<a.length;b+=2){for(var c=[0,.025,.05,.1,.2,.4,.8,1,1,1],d=[1,1,1,.8,.4,.2,.1,.05,.025,0],e=0;e<c.length;e++)c[e]=1*c[e]/(b+1),d[e]=1*d[e]/(b+1);c=new Envelope(b+1,c,d,.1,.1);a[b]=c}for(b=1;b<a.length;b+=2)c=new Envelope(b+1,zeroArray(10),zeroArray(10),.1,.1),a[b]=c;return new Instrument(a)}
function trianglePreset(a){a=Array(a);for(var b=0;b<a.length;b+=2){for(var c=[0,.025,.05,.1,.2,.4,.8,1,1,1],d=[1,1,1,.8,.4,.2,.1,.05,.025,0],e=0;e<c.length;e++)c[e]=1*c[e]/Math.pow(b+1,2),d[e]=1*d[e]/Math.pow(b+1,2);c=new Envelope(b+1,c,d,.1,.1);a[b]=c}for(b=1;b<a.length;b+=2)c=new Envelope(b+1,zeroArray(10),zeroArray(10),.1,.1),a[b]=c;return new Instrument(a)}
function sawtoothPreset(a){a=Array(a);for(var b=0;b<a.length;b++){for(var c=[0,.025,.05,.1,.2,.4,.8,1,1,1],d=[1,1,1,.8,.4,.2,.1,.05,.025,0],e=0;e<c.length;e++)c[e]=1*c[e]/(b+1),d[e]=1*d[e]/(b+1);c=new Envelope(b+1,c,d,.1,.1);a[b]=c}return new Instrument(a)}
function bellPreset(a){a=Array(a);a[0]=new Envelope(1,zeroArray(10),zeroArray(10),.1,.1);a[1]=new Envelope(.56,linspace(0,.374,10),linspace(.374,0,10),.1,1);a[2]=new Envelope(.56,linspace(0,.251,10),linspace(.251,0,10),.9*.1,.9);a[3]=new Envelope(.92,linspace(0,.374,10),linspace(.374,0,10),.065,.65);a[4]=new Envelope(.93,linspace(0,.674,10),linspace(.674,0,10),.55*.1,.55);a[5]=new Envelope(1.19,linspace(0,1,10),linspace(1,0,10),.0325,.325);a[6]=new Envelope(1.7,linspace(0,.625,10),linspace(.625,0,
10),.35*.1,.35);a[7]=new Envelope(2,linspace(0,.546,10),linspace(.546,0,10),.025,.25);a[8]=new Envelope(2.74,linspace(0,.498,10),linspace(.498,0,10),.2*.1,.2);a[9]=new Envelope(3,linspace(0,.498,10),linspace(.498,0,10),.015,.15);a[10]=new Envelope(3.76,linspace(0,.374,10),linspace(.374,0,10),.1*.1,.1);a[11]=new Envelope(3.76,linspace(0,.498,10),linspace(.498,0,10),.0075,.075);for(var b=12;b<a.length;b++){var c=new Envelope(b+1,zeroArray(10),zeroArray(10),.1,.1);a[b]=c}return new Instrument(a)}
function clarinetPreset(a){a=Array(a);a[0]=new Envelope(1,logspace(0,1,6).concat(logspace(1,.5,4)),linspace(.5,0,10),.06,.35);a[0].tremolo={amplitude:.1,frequency:.9};a[0].vibrato={amplitude:3.9,frequency:.1};a[1]=new Envelope(3,logspace(0,.75,6).concat(logspace(.75,.375,4)),linspace(.375,0,10),.06,.25);a[1].tremolo={amplitude:.15,frequency:.8};a[1].vibrato={amplitude:4.7,frequency:.15};a[2]=new Envelope(5,logspace(0,.5,5).concat(logspace(.5,.25,5)),linspace(.25,0,10),.06,.18);a[2].tremolo={amplitude:.2,
frequency:.4};a[2].vibrato={amplitude:2.4,frequency:.12};a[3]=new Envelope(7,logspace(0,.14,5).concat(logspace(.14,.07,5)),linspace(.07,0,10),.08,.13);a[3].tremolo={amplitude:.05,frequency:.5};a[3].vibrato={amplitude:3.44,frequency:.13};a[4]=new Envelope(9,logspace(0,.5,5).concat(logspace(.5,.25,5)),linspace(.25,0,10),.08,.09);a[4].tremolo={amplitude:.25,frequency:.2};a[4].vibrato={amplitude:3.1,frequency:.23};a[5]=new Envelope(11,logspace(0,.12,5).concat(logspace(.12,.06,5)),linspace(.06,0,10),.1,
.05);a[5].tremolo={amplitude:.1,frequency:.6};a[5].vibrato={amplitude:2.51,frequency:.7};a[6]=new Envelope(13,logspace(0,.03,5).concat(logspace(.03,.015,5)),linspace(.015,0,10),.01,.05);a[6].tremolo={amplitude:.1,frequency:1};a[6].vibrato={amplitude:2.9,frequency:.4};for(var b=7;b<a.length;b++){var c=new Envelope(b+1,zeroArray(10),zeroArray(10),.1,.1);a[b]=c}b=Array(1);b[0]=new Envelope(1,linspace(0,.1,3).concat(linspace(.1,.04,3)).concat(linspace(.05,.02,4)),linspace(.02,0,10),.2,.05);b[0].equalizer=
filledArray(30,-40);b[0].equalizer[0]=2;b[0].equalizer[1]=-10;return new Instrument(a,b)}
function initPresets(){presets.sine=sinePreset(30).Copy();presets.square=squarePreset(30).Copy();presets.sawtooth=sawtoothPreset(30).Copy();presets.triangle=trianglePreset(30).Copy();presets["risset bell"]=bellPreset(30).Copy();presets["clarinet?"]=clarinetPreset(30).Copy();for(var a=0;a<localStorage.length;a++){var b=localStorage.key(a);console.log("Loading custom preset: "+b);presets[b]=JSON.parse(localStorage.getItem(b))}a=document.getElementById("preset");for(b in presets){var c=document.createElement("option");
c.text=b;c.value=b;a.add(c)}a.addEventListener("change",function(a){instrument=presets[a.target.value];updateUI()})}
function savePreset(a){a=document.getElementById("save");if("none"==a.style.display)return!1;var b=prompt("Save Instrument as:");if(null==b||""==b)return!1;localStorage.setItem(b,JSON.stringify(instrument));for(var c=document.getElementById("preset"),d=document.createElement("option"),e=0;e<c.options.length;e++)if(c.options[e].value==b){c.options.selectedIndex=e;a.style.display="none";return}d.text=b;d.value=b;c.add(d);c.options.selectedIndex=c.options.length-1;a.style.display="none";presets[b]=instrument}
function updateUI(){updateEnvelopeUI("harmonics");updateEnvelopeUI("noises")}
function updateEnvelopeUI(a){for(var b=document.getElementsByClassName(a),c=0;c<instrument[a].length;c++){var d=b[c].getElementsByClassName("envelope");d[0].getElementsByTagName("input");d[1].getElementsByTagName("input");for(var e=0;e<d.length;e++)for(var g=d[e].getAttribute("data-property"),h=d[e].getElementsByTagName("input"),f=0;f<h.length;f++)h[f].value=instrument[a][c][g][f],change(b[c],h[f]);f=b[c].getElementsByClassName("end_time")[0].getElementsByTagName("input")[0];d=b[c].getElementsByClassName("end_time")[1].getElementsByTagName("input")[0];
f.value=instrument[a][c].attack_time;d.value=instrument[a][c].release_time;optional_props=b[c].getElementsByClassName("optional_property");for(f=0;f<optional_props.length;f++)for(d=optional_props[f].getElementsByTagName("input"),e=0;e<d.length;e++)g=d[e].getAttribute("data-property"),h=d[e].name,d[e].value=instrument[a][c][g][h],0!=instrument[a][c][g][h]&&(optional_props[f].style.display="block",optional_props[f].previousElementSibling.getElementsByTagName("input")[0].checked="checked");b[c].getElementsByClassName("harmonic_number")[0].value=
instrument[a][c].harmonic}}
function show_harmonics(a){for(var b=a.target.parentNode.children,c=0;c<b.length;c++)b[c].className=b[c].className.replace("current","");a.target.className=(a.target.className+" current").trim();for(var c=a.target.innerText.split("-"),b=c[0],d=c[1],e=document.getElementsByClassName("harmonic_settings"),c=0;c<e.length;c++)e[c].style.display=c>=b&&c<=d?"block":"none";if("noise"==a.target.innerText)for(a=document.getElementsByClassName("noises"),c=0;c<a.length;c++)a[c].style.display="block"}
function updateCSS(a,b,c){for(var d=document.styleSheets,e=0;e<d.length;e++)for(var g=d[e].cssRules,h=0;h<g.length;h++){var f=g[h];if(a==f.selectorText){var k=new RegExp(b+"(.*);","gm");if(f.cssText.match(k)){newrule=f.cssText.replace(k,b+': "'+c+'";');d[e].deleteRule(h);d[e].insertRule(newrule,h);return}}}}
function change(a,b){var c=a.getAttribute("data-harmonic"),d=a.getAttribute("data-type"),e=b.name,g=parseFloat(b.value);if("attack9"==e){a.getElementsByClassName("envelope")[1].firstElementChild.value=g;instrument[d][c].release_env[0]=g;var h=a.getElementsByClassName("sustain-line")[0];drawSustainLine(h,g)}"release0"==e&&(attack_end=a.getElementsByClassName("envelope")[0].lastElementChild,attack_end.value=g,instrument[d][c].attack_env[9]=g,h=a.getElementsByClassName("sustain-line")[0],drawSustainLine(h,
g));"attack_time"==e?instrument[d][c].attack_time=g:"release_time"==e?instrument[d][c].release_time=g:"attack"==e.slice(0,-1)?(e=e.slice(-1),instrument[d][c].attack_env[e]=g):"release"==e.slice(0,-1)?(e=e.slice(-1),instrument[d][c].release_env[e]=g):"harmonic_number"==e?instrument[d][c].harmonic=g:"spectrum"==e.replace(/[0-9]/g,"")&&(e=e.replace(/\D/g,""),instrument[d][c].equalizer[e]=g)}
function inputChange(a){var b=parseFloat(a.target.value);updateCSS('input[type="range"]:focus::-webkit-slider-thumb::after',"content",b.toFixed(2));change(this,a.target);document.getElementById("preset").options.selectedIndex=-1;document.getElementById("save").style.display="inline-block"}
function optionalPropChange(a){var b=parseInt(a.target.form.getAttribute("data-harmonic")),c=a.target.form.getAttribute("data-type"),d=a.target.getAttribute("data-property");instrument[c][b][d][a.target.name]=parseFloat(a.target.value)}
function checkboxChange(a){var b=a.target.nextElementSibling;null==b&&(b=a.target.parentNode.nextElementSibling);if(a.target.checked){b.style.display="block";for(var b=b.getElementsByTagName("input"),c=0;c<b.length;c++)optionalPropChange({target:b[c]})}else for(b.style.display="none",a=parseInt(a.target.form.getAttribute("data-harmonic")),b=b.getElementsByTagName("input"),c=0;c<b.length;c++){var d=b[c].getAttribute("data-property"),e=b[c].getAttribute("data-type");instrument[e][a][d][b[c].name]=0}}
function shapeEnv(a){var b=parseInt(a.target.form.getAttribute("data-harmonic")),c=a.target.getAttribute("data-property"),d=a.target.getAttribute("data-type"),e=instrument[d][b][c];if("attack_env"==c){var g=e.slice(-1)[0];0==g&&(g=1);"linear"==a.target.value&&(instrument[d][b][c]=linspace(0,g,e.length));"log"==a.target.value&&(instrument[d][b][c]=logspace(0,g,e.length));"inv"==a.target.value&&(instrument[d][b][c]=inverse(instrument[d][b][c]));"zero"==a.target.value&&(instrument[d][b][c]=zeroArray(10))}else"release_env"==
c?(g=e[0],"linear"==a.target.value&&(instrument[d][b][c]=linspace(g,0,e.length)),"log"==a.target.value&&(instrument[d][b][c]=logspace(g,0,e.length)),"inv"==a.target.value&&(instrument[d][b][c]=inverse(instrument[d][b][c])),"zero"==a.target.value&&(instrument[d][b][c]=zeroArray(10))):"equalizer"==c&&("white"==a.target.value&&(instrument[d][b][c]=zeroArray(instrument[d][b][c].length)),"pink"==a.target.value&&(instrument[d][b][c]=linspace(5,-20,instrument[d][b][c].length)),"brown"==a.target.value&&(instrument[d][b][c]=
linspace(5,-40,instrument[d][b][c].length)),"grey"==a.target.value&&(instrument[d][b][c]=greyNoise(-30,0,instrument[d][b][c].length)),"silence"==a.target.value&&(instrument[d][b][c]=filledArray(instrument[d][b][c].length,-50)));updateUI()}
function drawSustainLine(a,b){if(a.getContext){var c=a.getContext("2d");b*=a.height;c.clearRect(0,0,a.width,a.height);c.lineWidth=5;c.lineCap="round";c.strokeStyle="rgb(255, 255, 255)";var d=new Path2D;d.moveTo(10,a.height-b);d.lineTo(a.width-15,a.height-b);c.stroke(d)}}
function initUI(){var a=document.getElementsByClassName("harmonic_settings");for(i=0;i<a.length;i++)a[i].addEventListener("input",inputChange),a[i].addEventListener("focus",inputChange,!0);updateUI();a=document.getElementsByClassName("harmonics_tab");for(i=0;i<a.length;i++)a[i].addEventListener("click",show_harmonics);document.getElementById("save").addEventListener("click",savePreset);a=document.getElementsByClassName("checkbox");for(i=0;i<a.length;i++)a[i].addEventListener("change",checkboxChange);
a=document.getElementsByClassName("optional_property");for(i=0;i<a.length;i++)a[i].addEventListener("input",optionalPropChange);a=document.getElementsByClassName("env_shaper");for(i=0;i<a.length;i++)a[i].addEventListener("click",shapeEnv)}
function initSynth(){window.AudioContext=window.AudioContext||window.webkitAudioContext;try{if("undefined"==typeof audioContext||null==audioContext)audioContext=new AudioContext}catch(a){alert("The Web Audio API is not supported in this browser.")}output=audioContext.createGain();output.connect(audioContext.destination);initPresets();instrument=presets.sine.Copy();initUI();noise_buffer=noiseBuffer(3*audioContext.sampleRate)}document.addEventListener("DOMContentLoaded",function(){initSynth()},!1);
