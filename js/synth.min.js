var audioContext,voices=[],output,envelopes=Array(30),presets={};function frequencyFromNoteNumber(a){return 440*Math.pow(2,(a-69)/12)}function allZeros(a){for(i=0;i<a.length;i++)if(0!==a[i])return!1;return!0}function linspace(a,c,b){"undefined"===typeof b&&(b=Math.max(Math.round(c-a)+1,1));if(2>b)return 1===b?[a]:[];var e,d=Array(b);b--;for(e=b;0<=e;e--)d[e]=(e*c+(b-e)*a)/b;return d}
function logspace(a,c,b){0==a?(a=-3,c=Math.log(c)/Math.LN10):0==c?(c=-3,a=Math.log(a)/Math.LN10):(a=Math.log(a)/Math.LN10,c=Math.log(c)/Math.LN10);return linspace(a,c,b).map(function(a){return Math.pow(10,a)})}function noteOn(a,c){if(null==voices[a]){console.log("note on: "+a+" "+c);voices[a]=new Voice(a,c);var b=document.getElementById("k"+a);b&&b.classList.add("pressed")}}
function noteOff(a){null!=voices[a]&&(voices[a].noteOff(),voices[a]=null,(a=document.getElementById("k"+a))&&a.classList.remove("pressed"))}function Envelope(a,c,b,e,d){this.attack_env=c;this.release_env=b;this.attack_time=e;this.release_time=d;this.harmonic=a;this.vibrato={frequency:0,amplitude:0};this.tremolo={frequency:0,amplitude:0}}
function Voice(a,c){this.num_harmonics=envelopes.length;this.frequency=frequencyFromNoteNumber(a);this.postGain=audioContext.createGain();this.oscillators=[];this.gain_envs=[];this.max_volume=0;now=audioContext.currentTime;for(var b=0;b<this.num_harmonics;b++)if(!allZeros(envelopes[b].attack_env)||!allZeros(envelopes[b].release_env)){osc=audioContext.createOscillator();osc.frequency.value=this.frequency*envelopes[b].harmonic;var e=audioContext.createGain();e.gain.setValueAtTime(0,now);for(var d=envelopes[b].attack_env,
f=0;f<d.length;f++)time=envelopes[b].attack_time*f/(d.length-1),e.gain.linearRampToValueAtTime(d[f],now+time);0!=envelopes[b].vibrato.frequency&&0!=envelopes[b].vibrato.amplitude&&(d=audioContext.createOscillator(),f=audioContext.createGain(),d.frequency.value=envelopes[b].vibrato.frequency,f.gain.value=envelopes[b].vibrato.amplitude,d.connect(f),f.connect(osc.frequency),d.start(0));if(0!=envelopes[b].tremolo.frequency&&0!=envelopes[b].tremolo.amplitude){var d=audioContext.createOscillator(),f=audioContext.createGain(),
g=audioContext.createGain();d.frequency.value=envelopes[b].tremolo.frequency;f.gain.value=envelopes[b].tremolo.amplitude;g.gain.value=1;d.connect(f);f.connect(g.gain);d.start(0);osc.connect(g);g.connect(e)}else osc.connect(e);e.connect(this.postGain);this.oscillators[b]=osc;this.gain_envs[b]=e;osc.start(0)}this.postGain.connect(output);this.postGain.gain.value=5/this.num_harmonics*c}
Voice.prototype.noteOff=function(){var a=audioContext.currentTime;console.log("noteoff: now: "+a);for(var c=0;c<this.num_harmonics;c++){var b=this.oscillators[c];if(null!=b){var e=this.gain_envs[c];e.gain.cancelScheduledValues(a);var d=e.gain.value.toFixed(6)/envelopes[c].release_env[0].toFixed(6);isFinite(d)||(d=1);for(var f=envelopes[c].release_env,g=0;g<f.length;g++){var h=envelopes[c].release_time*g/(f.length-1);e.gain.linearRampToValueAtTime(f[g]*d,a+h)}b.stop(a+2*parseFloat(h))}}};
function sinePreset(){var a=Array(envelopes.length),c=new Envelope(1,[0,.025,.05,.1,.2,.4,.8,1,1,1],[1,1,1,.8,.4,.2,.1,.05,.025,0],.1,.1);a[0]=c;for(var b=1;b<a.length;b++)c=new Envelope(b+1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,.1),a[b]=c;return a}
function squarePreset(){for(var a=Array(envelopes.length),c=0;c<a.length;c+=2){for(var b=[0,.025,.05,.1,.2,.4,.8,1,1,1],e=[1,1,1,.8,.4,.2,.1,.05,.025,0],d=0;d<b.length;d++)b[d]=1*b[d]/(c+1),e[d]=1*e[d]/(c+1);b=new Envelope(c+1,b,e,.1,.1);a[c]=b}for(c=1;c<a.length;c+=2)b=new Envelope(c+1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,.1),a[c]=b;return a}
function trianglePreset(){for(var a=Array(envelopes.length),c=0;c<a.length;c+=2){for(var b=[0,.025,.05,.1,.2,.4,.8,1,1,1],e=[1,1,1,.8,.4,.2,.1,.05,.025,0],d=0;d<b.length;d++)b[d]=1*b[d]/Math.pow(c+1,2),e[d]=1*e[d]/Math.pow(c+1,2);b=new Envelope(c+1,b,e,.1,.1);a[c]=b}for(c=1;c<a.length;c+=2)b=new Envelope(c+1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,.1),a[c]=b;return a}
function sawtoothPreset(){for(var a=Array(envelopes.length),c=0;c<a.length;c++){for(var b=[0,.025,.05,.1,.2,.4,.8,1,1,1],e=[1,1,1,.8,.4,.2,.1,.05,.025,0],d=0;d<b.length;d++)b[d]=1*b[d]/(c+1),e[d]=1*e[d]/(c+1);b=new Envelope(c+1,b,e,.1,.1);a[c]=b}return a}
function bellPreset(){var a=Array(envelopes.length);a[0]=new Envelope(1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,.1);a[1]=new Envelope(.56,linspace(0,.374,10),linspace(.374,0,10),.1,1);a[2]=new Envelope(.56,linspace(0,.251,10),linspace(.251,0,10),.9*.1,.9);a[3]=new Envelope(.92,linspace(0,.374,10),linspace(.374,0,10),.065,.65);a[4]=new Envelope(.93,linspace(0,.674,10),linspace(.674,0,10),.55*.1,.55);a[5]=new Envelope(1.19,linspace(0,1,10),linspace(1,0,10),.0325,.325);a[6]=new Envelope(1.7,linspace(0,
.625,10),linspace(.625,0,10),.35*.1,.35);a[7]=new Envelope(2,linspace(0,.546,10),linspace(.546,0,10),.025,.25);a[8]=new Envelope(2.74,linspace(0,.498,10),linspace(.498,0,10),.2*.1,.2);a[9]=new Envelope(3,linspace(0,.498,10),linspace(.498,0,10),.015,.15);a[10]=new Envelope(3.76,linspace(0,.374,10),linspace(.374,0,10),.1*.1,.1);a[11]=new Envelope(3.76,linspace(0,.498,10),linspace(.498,0,10),.0075,.075);for(var c=12;c<a.length;c++){var b=new Envelope(c+1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,
.1);a[c]=b}return a}
function clarinetPreset(){var a=Array(envelopes.length);a[0]=new Envelope(1,logspace(0,1,6).concat(logspace(1,.5,4)),logspace(.5,0,10),.03,.4);a[0].tremolo={amplitude:.1,frequency:.9};a[0].vibrato={amplitude:3.9,frequency:.1};a[1]=new Envelope(3,logspace(0,.75,6).concat(logspace(.75,.375,4)),logspace(.375,0,10),.03,.3);a[1].tremolo={amplitude:.15,frequency:.8};a[1].vibrato={amplitude:4.7,frequency:.15};a[2]=new Envelope(5,logspace(0,.5,5).concat(logspace(.5,.25,5)),logspace(.25,0,10),.03,.2);a[2].tremolo=
{amplitude:.2,frequency:.4};a[2].vibrato={amplitude:2.4,frequency:.12};a[3]=new Envelope(7,logspace(0,.14,5).concat(logspace(.14,.07,5)),logspace(.07,0,10),.04,.15);a[3].tremolo={amplitude:.05,frequency:.5};a[3].vibrato={amplitude:3.44,frequency:.13};a[4]=new Envelope(9,logspace(0,.5,5).concat(logspace(.5,.25,5)),logspace(.25,0,10),.04,.1);a[4].tremolo={amplitude:.25,frequency:.2};a[4].vibrato={amplitude:3.1,frequency:.23};a[5]=new Envelope(11,logspace(0,.12,5).concat(logspace(.12,.06,5)),logspace(.06,
0,10),.05,.05);a[5].tremolo={amplitude:.1,frequency:.6};a[5].vibrato={amplitude:2.51,frequency:.7};a[6]=new Envelope(13,logspace(0,.17,5).concat(logspace(.17,.085,5)),logspace(.085,0,10),.05,.05);a[6].tremolo={amplitude:.1,frequency:1};a[6].vibrato={amplitude:2.9,frequency:.4};for(var c=7;c<a.length;c++){var b=new Envelope(c+1,[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],.1,.1);a[c]=b}return a}
function initPresets(){presets.sine=sinePreset();presets.square=squarePreset();presets.sawtooth=sawtoothPreset();presets.triangle=trianglePreset();presets["risset bell"]=bellPreset();presets["clarinet?"]=clarinetPreset();for(var a=0;a<localStorage.length;a++){var c=localStorage.key(a);console.log("Loading custom preset: "+c);presets[c]=JSON.parse(localStorage.getItem(c))}a=document.getElementById("preset");for(c in presets){var b=document.createElement("option");b.text=c;b.value=c;a.add(b)}a.addEventListener("change",
function(a){envelopes=presets[a.target.value].slice();updateEnvelopeUI()})}
function savePreset(a){a=document.getElementById("save");if("none"==a.style.display)return!1;var c=prompt("Save Instrument as:");if(null==c||""==c)return!1;localStorage.setItem(c,JSON.stringify(envelopes));for(var b=document.getElementById("preset"),e=document.createElement("option"),d=0;d<b.options.length;d++)if(b.options[d].value==c){b.options.selectedIndex=d;a.style.display="none";return}e.text=c;e.value=c;b.add(e);b.options.selectedIndex=b.options.length-1;a.style.display="none";presets[c]=envelopes.slice()}
function updateEnvelopeUI(){for(var a=document.getElementsByClassName("harmonic_settings"),c=0;c<envelopes.length;c++){for(var b=a[c].getElementsByClassName("envelope"),e=b[0].getElementsByTagName("input"),d=b[1].getElementsByTagName("input"),b=0;b<e.length;b++)e[b].value=envelopes[c].attack_env[b],change(a[c],e[b]);for(b=0;b<d.length;b++)d[b].value=envelopes[c].release_env[b],change(a[c],d[b]);b=a[c].getElementsByClassName("end_time")[0].getElementsByTagName("input")[0];e=a[c].getElementsByClassName("end_time")[1].getElementsByTagName("input")[0];
b.value=envelopes[c].attack_time;e.value=envelopes[c].release_time;optional_props=a[c].getElementsByClassName("optional_property");for(b=0;b<optional_props.length;b++)for(e=optional_props[b].getElementsByTagName("input"),d=0;d<e.length;d++){var f=e[d].getAttribute("data-property"),g=e[d].name;e[d].value=envelopes[c][f][g];0!=envelopes[c][f][g]&&(optional_props[b].style.display="block",optional_props[b].previousElementSibling.getElementsByTagName("input")[0].checked="checked")}a[c].getElementsByClassName("harmonic_number")[0].value=
envelopes[c].harmonic}}function show_harmonics(a){for(var c=a.target.parentNode.children,b=0;b<c.length;b++)c[b].className=c[b].className.replace("current","");a.target.className=(a.target.className+" current").trim();b=a.target.innerText.split("-");a=b[0];for(var c=b[1],e=document.getElementsByClassName("harmonic_settings"),b=0;b<e.length;b++)e[b].style.display=b>=a&&b<=c?"block":"none"}
function updateCSS(a,c,b){for(var e=document.styleSheets,d=0;d<e.length;d++)for(var f=e[d].cssRules,g=0;g<f.length;g++){var h=f[g];if(a==h.selectorText){var k=new RegExp(c+"(.*);","gm");if(h.cssText.match(k)){newrule=h.cssText.replace(k,c+': "'+b+'";');e[d].deleteRule(g);e[d].insertRule(newrule,g);return}}}}
function change(a,c){var b=a.id.substring(1),e=c.name,d=parseFloat(c.value);if("attack9"==e){a.getElementsByClassName("envelope")[1].firstElementChild.value=d;envelopes[b].release_env[0]=d;var f=a.getElementsByClassName("sustain-line")[0];drawSustainLine(f,d)}"release0"==e&&(attack_end=a.getElementsByClassName("envelope")[0].lastElementChild,attack_end.value=d,envelopes[b].attack_env[9]=d,f=a.getElementsByClassName("sustain-line")[0],drawSustainLine(f,d));"attack_time"==e?envelopes[b].attack_time=
d:"release_time"==e?envelopes[b].release_time=d:"attack"==e.slice(0,-1)?(num=e.slice(-1),envelopes[b].attack_env[num]=d):"release"==e.slice(0,-1)?(num=e.slice(-1),envelopes[b].release_env[num]=d):"harmonic_number"==e&&(envelopes[b].harmonic=d)}
function inputChange(a){parseInt(this.id.substring(1));var c=parseFloat(a.target.value);updateCSS('input[type="range"]:focus::-webkit-slider-thumb::after',"content",c.toFixed(2));change(this,a.target);document.getElementById("preset").options.selectedIndex=-1;document.getElementById("save").style.display="inline-block"}function optionalPropChange(a){var c=parseInt(a.target.form.id.substring(1)),b=a.target.getAttribute("data-property");envelopes[c][b][a.target.name]=parseFloat(a.target.value)}
function checkboxChange(a){var c=a.target.nextElementSibling;null==c&&(c=a.target.parentNode.nextElementSibling);if(a.target.checked){c.style.display="block";for(var c=c.getElementsByTagName("input"),b=0;b<c.length;b++)optionalPropChange({target:c[b]})}else for(c.style.display="none",a=parseInt(a.target.form.id.substring(1)),c=c.getElementsByTagName("input"),b=0;b<c.length;b++){var e=c[b].getAttribute("data-property");envelopes[a][e][c[b].name]=0}}
function shapeEnv(a){var c=parseInt(a.target.form.id.substring(1)),b=a.target.getAttribute("data-property"),e=envelopes[c][b];if("attack_env"==b){var d=e.slice(-1)[0];0==d&&(d=1);"linear"==a.target.value&&(envelopes[c][b]=linspace(0,d,e.length));"log"==a.target.value&&(envelopes[c][b]=logspace(0,d,e.length))}else"release_env"==b&&(d=e[0],"linear"==a.target.value&&(envelopes[c][b]=linspace(d,0,e.length)),"log"==a.target.value&&(envelopes[c][b]=logspace(d,0,e.length)));updateEnvelopeUI()}
function drawSustainLine(a,c){if(a.getContext){var b=a.getContext("2d");c*=a.height;b.clearRect(0,0,a.width,a.height);b.lineWidth=5;b.lineCap="round";b.strokeStyle="rgb(255, 255, 255)";var e=new Path2D;e.moveTo(10,a.height-c);e.lineTo(a.width-15,a.height-c);b.stroke(e)}}
function initUI(){var a=document.getElementsByClassName("harmonic_settings");for(i=0;i<a.length;i++)a[i].addEventListener("input",inputChange),a[i].addEventListener("focus",inputChange,!0);updateEnvelopeUI();a=document.getElementsByClassName("harmonics_tab");for(i=0;i<a.length;i++)a[i].addEventListener("click",show_harmonics);document.getElementById("save").addEventListener("click",savePreset);a=document.querySelectorAll("input[type=number]");for(i=0;i<a.length;i++)a[i].addEventListener("keypress",
function(a){(48>a.which||57<a.which)&&a.preventDefault()});a=document.getElementsByClassName("checkbox");for(i=0;i<a.length;i++)a[i].addEventListener("change",checkboxChange);a=document.getElementsByClassName("optional_property");for(i=0;i<a.length;i++)a[i].addEventListener("input",optionalPropChange);a=document.getElementsByClassName("env_shaper");for(i=0;i<a.length;i++)a[i].addEventListener("click",shapeEnv)}
function initSynth(){window.AudioContext=window.AudioContext||window.webkitAudioContext;try{if("undefined"==typeof audioContext||null==audioContext)audioContext=new AudioContext}catch(a){alert("The Web Audio API is not supported in this browser.")}output=audioContext.createGain();output.connect(audioContext.destination);initPresets();envelopes=presets.sine.slice();initUI()}document.addEventListener("DOMContentLoaded",function(){initSynth()},!1);
