var audioContext,graph_in,analyser,graphs=["spectrum","spectrogram","oscilloscope","waveform","cepstrum"],canvasCtx={},scriptProcs={},tempCtx,waveform_x=0,waveform_y=150,num_plots;
function init(){window.AudioContext=window.AudioContext||window.webkitAudioContext;try{if("undefined"==typeof audioContext||null==audioContext)audioContext=new AudioContext}catch(a){alert("Web Audio API is not supported in this browser")}finally{graph_in=audioContext.createGain(),analyser=audioContext.createAnalyser(),analyser.smoothingTimeConstant=0,-1<navigator.userAgent.indexOf("Safari")&&-1>=navigator.userAgent.indexOf("Chrome")?analyser.fftSize=2048:analyser.fftSize=4096,graph_in.connect(analyser),
initCanvas()}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}
function initCanvas(){var a;scripts={spectrum:drawSpectrum,spectrogram:drawSpectrogram,oscilloscope:drawOscilloscope,waveform:drawWaveform,cepstrum:drawCepstrum};for(var b=0;b<graphs.length;b++)if(graph=graphs[b],a=document.getElementById(graph))canvasCtx[graph]=a.getContext("2d"),a.width=a.offsetWidth,a.height=a.offsetHeight,-1<navigator.userAgent.indexOf("Safari")&&navigator.userAgent.indexOf("Chrome"),scriptProcs[graph]=audioContext.createScriptProcessor(1024),scriptProcs[graph].connect(audioContext.destination),
analyser.connect(scriptProcs[graph]),scriptProcs[graph].onaudioprocess=scripts[graph];num_plots=Object.keys(canvasCtx).length;b=document.createElement("canvas");tempCtx=b.getContext("2d");b.width=canvasCtx.spectrogram.canvas.width;b.height=canvasCtx.spectrogram.canvas.height;update_graph_heights();a=document.getElementsByClassName("remove_button");for(b=0;b<a.length;b++)a[b].addEventListener("click",remove_parent,!1)}
function drawOscilloscope(){if(document.getElementById("oscilloscope")){var a=new Uint8Array(analyser.frequencyBinCount);analyser.getByteTimeDomainData(a);var b=canvasCtx.oscilloscope.canvas;canvasCtx.oscilloscope.clearRect(0,0,b.width,b.height);binWidth=b.width/(analyser.frequencyBinCount-1);canvasCtx.oscilloscope.lineWidth=3;canvasCtx.oscilloscope.strokeStyle="rgb(255, 255, 255)";canvasCtx.oscilloscope.beginPath();for(var c=0;c<a.length;c++){var d=a[c]/256;x=c*binWidth;y=d*b.height;0===c?canvasCtx.oscilloscope.moveTo(x,
y):canvasCtx.oscilloscope.lineTo(x,y)}canvasCtx.oscilloscope.stroke()}}
function drawWaveform(){var a=new Uint8Array(analyser.frequencyBinCount);analyser.getByteTimeDomainData(a);var b=canvasCtx.waveform.canvas;totalSamples=999999;timeBinWidth=b.width/(totalSamples/scriptProcs.waveform.bufferSize);if(!isNaN(timeBinWidth)){canvasCtx.waveform.lineWidth=1;canvasCtx.waveform.strokeStyle="rgb(255, 255, 255)";canvasCtx.waveform.beginPath();canvasCtx.waveform.moveTo(waveform_x,waveform_y);for(var c=0;c<a.length;c++){var d=a[Math.floor(c)]/256;waveform_x+=timeBinWidth/a.length;
waveform_x>b.width&&(waveform_x=0,canvasCtx.waveform.clearRect(0,0,b.width,b.height),canvasCtx.waveform.moveTo(waveform_x,waveform_y));waveform_y=d*b.height;canvasCtx.waveform.lineTo(waveform_x,waveform_y)}canvasCtx.waveform.stroke()}}
function drawSpectrum(){var a=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(a);canvasCtx.spectrum.clearRect(0,0,canvasCtx.spectrum.canvas.width,canvasCtx.spectrum.canvas.height);canvasCtx.spectrum.fillStyle=make_gradient(canvasCtx.spectrum);for(var b=canvasCtx.spectrum.canvas.width/analyser.frequencyBinCount,c=0;c<a.length;c++)canvasCtx.spectrum.fillRect(c*b,canvasCtx.spectrum.canvas.height,b,-(canvasCtx.spectrum.canvas.height*a[c]/256))}
function drawSpectrogram(){canvas=canvasCtx.spectrogram.canvas;tempCtx.drawImage(canvas,0,0,canvas.width,canvas.height);var a=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(a);audioDuration=1;totalSamples=999999;timeBinWidth=canvas.width/(totalSamples/scriptProcs.spectrogram.bufferSize);timeBinWidth=Math.max(timeBinWidth,1);freqBinWidth=canvas.height/analyser.frequencyBinCount;for(var b=0;b<a.length;b++){var c=a[b];canvasCtx.spectrogram.fillStyle="#"+c.toString(16)+c.toString(16)+
c.toString(16);canvasCtx.spectrogram.fillRect(canvas.width-timeBinWidth,canvas.height-b*freqBinWidth,timeBinWidth,canvas.height/a.length)}canvasCtx.spectrogram.translate(-timeBinWidth,0);canvasCtx.spectrogram.drawImage(tempCtx.canvas,0,0,canvas.width,canvas.height,0,0,canvas.width,canvas.height);canvasCtx.spectrogram.setTransform(1,0,0,1,0,0)}
function drawCepstrum(){var a=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(a);var b=canvasCtx.cepstrum.canvas.width/(analyser.frequencyBinCount/2),c=new complex_array.ComplexArray(a.length);c.map(function(b,c,d){b.real=a[c]});c.FFT();mag_array=c.magnitude();canvasCtx.cepstrum.clearRect(0,0,canvasCtx.cepstrum.canvas.width,canvasCtx.cepstrum.canvas.height);canvasCtx.cepstrum.fillStyle=make_gradient(canvasCtx.cepstrum);for(c=1;c<mag_array.length/2;c++){var d=20*Math.log(mag_array[c])/
Math.LN10;canvasCtx.cepstrum.fillRect((c-1)*b,canvasCtx.cepstrum.canvas.height,b,-d)}}function make_gradient(a){a=a.createLinearGradient(0,0,0,a.canvas.height);a.addColorStop(1,"#000000");a.addColorStop(.85,"#ff0000");a.addColorStop(.35,"#ffff00");a.addColorStop(0,"#ffffff");return a}
function update_graph_heights(){percent=55/num_plots;wrappers=document.getElementsByClassName("plot_wrapper");for(var a=0;a<wrappers.length;a++)wrappers[a].style.height=percent+"vh";for(a=0;a<graphs.length;a++)graph=graphs[a],canvasCtx[graph]&&(canvas=canvasCtx[graph].canvas,canvas.height=canvas.offsetHeight);tempCtx.canvas.height=canvasCtx.spectrogram.canvas.offsetHeight}
function remove_parent(a){this.parentNode.remove();--num_plots;update_graph_heights();scriptProcs[this.value].onaudioprocess=null}document.addEventListener("DOMContentLoaded",function(){init()},!1);
